name: CI
on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: '1.26'
      - run: make vet
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: '1.26'
      - run: make test
  e2e:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: '1.26'
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      - name: Build Docker images
        run: |
          make docker-build
      - name: Start Docker containers
        run: |
          ./tools/scripts/docker-compose-up.sh
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be ready..."
          for i in {1..30}; do
            if nc -z localhost 28080 2>/dev/null; then
              echo "Write API server port is open!"
              break
            fi
            echo "Waiting for write-api-server... ($i/30)"
            sleep 2
          done
          for i in {1..30}; do
            if nc -z localhost 28082 2>/dev/null; then
              echo "Read API server port is open!"
              break
            fi
            echo "Waiting for read-api-server... ($i/30)"
            sleep 2
          done
          echo "Additional wait for service initialization..."
          sleep 10
      - name: Run E2E tests
        run: |
          make verify-group-chat
      - name: Show logs on failure
        if: failure()
        run: |
          docker compose -p cqrs-es-example-go logs --tail=100
